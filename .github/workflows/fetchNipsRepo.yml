name: Fetch Open Pull Requests and Markdown Files

on:
  schedule:
    - cron: "0 0 * * *" # 毎日UTC 00:00（日本時間 09:00）に実行
  workflow_dispatch: # 手動実行も可能

jobs:
  fetch-prs-and-md-files:
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
      contents: write
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: GitHub API からオープンな PR を取得
        run: |
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/nostr-protocol/nips/pulls?state=open" | jq '.' > pull_requests.json

      - name: md ファイルの一覧を取得
        run: |
          # リポジトリ内の `.md` ファイルをリストアップして JSON 形式に変換
          find . -type f -name "*.md" | jq -R . | jq -s . > md_files.json

      - name: 変更があるか確認
        run: |
          echo "Checking for changes..."
          git status
          git diff

      - name: 変更があればコミットしてプッシュ
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions@github.com"
          git checkout main # main ブランチに切り替え

          # pull_requests.json と md_files.json に変更があれば commit を実行
          git add pull_requests.json md_files.json
          if git diff --quiet; then
            echo "No changes detected, skipping commit."
          else
            git commit -m "Update open pull requests list and markdown files list"
            git push origin main --force # main ブランチにプッシュ
          fi
