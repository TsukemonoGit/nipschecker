name: Fetch Open Pull Requests and Markdown Files

on:
  schedule:
    - cron: "0 0 * * *" # 毎日UTC 00:00（日本時間 09:00）に実行
  workflow_dispatch: # 手動実行も可能

jobs:
  fetch-prs-and-md-files:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # リポジトリのコンテンツを読む権限を与える
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: GitHub API からオープンな PR を取得
        run: |
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/nostr-protocol/nips/pulls?state=open" | jq '.' > pull_requests.json

      - name: GitHub API から .md ファイルを取得（レスポンス内容を確認）
        run: |
          # レスポンスの内容をデバッグして表示
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/nostr-protocol/nips/contents?ref=main" > response.json
          cat response.json  # レスポンス内容を表示

      - name: レスポンスから .md ファイルを抽出
        run: |
          # レスポンスが正しく取得できているかを確認後、.md ファイルを抽出
          jq -r '.[] | select(.name | endswith(".md")) | .path' response.json > md_files.json

      - name: md_files.json が生成されたか確認
        run: |
          # md_files.json ファイルが存在するか確認
          if [[ ! -f md_files.json ]]; then
            echo "Error: md_files.json was not created."
            exit 1
          else
            echo "md_files.json was successfully created."
          fi

      - name: 変更があればコミットしてプッシュ
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions@github.com"
          git checkout main # main ブランチに切り替え

          # pull_requests.json と md_files.json に変更があれば commit を実行
          git add pull_requests.json md_files.json
          
          # 明示的にステージングしてコミット
          if [[ `git status --porcelain` ]]; then
            git commit -m "Update open pull requests list and markdown files list"
            git push origin main --force # main ブランチにプッシュ
          else
            echo "No changes detected, skipping commit."
          fi
